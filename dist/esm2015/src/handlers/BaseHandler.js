import Styled from './Styled';
import { Constants, Helpers } from '../utils';
class BaseHandler {
    constructor(quill, options) {
        this.helpers = new Helpers();
        this.quill = quill;
        this.options = options;
        this.range = null;
        new Styled().apply();
        if (this.isNotExistLoading()) {
            const node = document.createElement('div');
            node.innerHTML = this.helpers.loadingHTML();
            this.quill.container.appendChild(node);
        }
        if (typeof this.options.upload !== 'function') {
            console.warn('[Missing config] upload function that returns a promise is required');
        }
        setTimeout(() => {
            if (!this.options.accepts) {
                if (this.handler === Constants.blots.image) {
                    this.options.accepts = ['jpg', 'jpeg', 'png'];
                }
                if (this.handler === Constants.blots.video) {
                    this.options.accepts = ['mp4', 'webm'];
                }
            }
            if (this.handler === Constants.blots.image) {
                this.possibleExtension = new Set(['apng', 'bmp', 'gif', 'ico', 'cur', 'jpg', 'jpeg', 'jfif', 'pjpeg', 'pjp', 'png', 'svg', 'tif', 'tiff', 'webp', 'pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx']);
            }
            if (this.handler === Constants.blots.video) {
                this.possibleExtension = new Set(['mp4', 'webm', '3gp', 'mp4', 'mpeg', 'quickTime', 'ogg']);
            }
            this.allowedFormatRegex = new RegExp('^(' + this.options.accepts.filter((el) => this.possibleExtension.has(el.toLowerCase()))
                .reduce((acc, el, i) => acc.concat(i !== 0 ? `|${el}` : `${el}`), '') + ')$', 'i');
        }, 1);
    }
    applyForToolbar() {
        const toolbar = this.quill.getModule('toolbar');
        this.loading = document.getElementById(`${Constants.ID_SPLIT_FLAG}.QUILL-LOADING`);
        toolbar.addHandler(this.handler, this.selectLocalFile.bind(this));
    }
    selectLocalFile() {
        this.range = this.quill.getSelection();
        this.fileHolder = document.createElement('input');
        this.fileHolder.setAttribute('type', 'file');
        this.fileHolder.setAttribute('accept', `${this.handler}/*`);
        this.fileHolder.onchange = this.fileChanged.bind(this);
        this.fileHolder.click();
    }
    loadFile(context) {
        this.loading.removeAttribute('class');
        this.loading.setAttribute('class', Constants.LOADING_CLASS_NAME);
        const file = context.fileHolder.files[0];
        this.handlerId = this.helpers.generateID();
        const fileReader = new FileReader();
        fileReader.addEventListener('load', () => {
            this.insertBase64Data(fileReader.result, this.handlerId);
        }, false);
        if (!file) {
            console.warn('[File not found] Something was wrong, please try again!!');
            return null;
        }
        fileReader.readAsDataURL(file);
        return { file, handlerId: this.handlerId };
    }
    fileChanged() {
        const { file, handlerId } = this.loadFile(this);
        if (!file) {
            return;
        }
        const extension = file.name.split('.').pop();
        if (!this.isValidExtension(extension)) {
            console.warn('[Wrong Format] Format was wrong, please try with correct format!!');
        }
        if (!this.hasValidMimeType(file.type)) {
            console.warn(`[Incorrect Mime Type] The MIME Type of uploaded file is not ${this.handler}!!`);
        }
        this.embedFile(file, handlerId);
    }
    embedFile(file, handlerId) {
        this.options.upload(file).then((url) => {
            this.insertFileToEditor(url, handlerId);
            this.loading.removeAttribute('class');
            this.loading.setAttribute('class', Constants.NONE_DISPLAY_CLASS_NAME);
        }, (error) => {
            this.loading.removeAttribute('class');
            this.loading.setAttribute('class', Constants.NONE_DISPLAY_CLASS_NAME);
            setTimeout(() => {
                const el = document.getElementById(handlerId);
                el.remove();
            }, 1000);
        });
    }
    insertBase64Data(url, handlerId) {
        const range = this.range;
        this.quill.insertEmbed(range.index, this.handler, `${handlerId}${Constants.ID_SPLIT_FLAG}${url}`);
        const el = document.getElementById(handlerId);
        if (el) {
            el.setAttribute('class', Constants.QUILL_UPLOAD_HOLDER_CLASS_NAME);
        }
    }
    insertFileToEditor(url, handlerId) {
        const el = document.getElementById(handlerId);
        if (el) {
            el.setAttribute('src', url);
            el.removeAttribute('id');
            el.removeAttribute('class');
        }
    }
    isValidExtension(extension) {
        return extension && this.allowedFormatRegex.test(extension);
    }
    hasValidMimeType(type) {
        return type && type.startsWith(this.handler);
    }
    isNotExistLoading() {
        const loading = document.getElementById(`${Constants.ID_SPLIT_FLAG}.QUILL-LOADING`);
        return loading == null;
    }
}
export default BaseHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmFzZUhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvaGFuZGxlcnMvQmFzZUhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxNQUFNLE1BQU0sVUFBVSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBWTlDLE1BQU0sV0FBVztJQVlmLFlBQVksS0FBSyxFQUFFLE9BQWdCO1FBSm5DLFlBQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBS3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBRWxCLElBQUksTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFckIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtZQUM1QixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUU1QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDeEM7UUFFRCxJQUFJLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEtBQUssVUFBVSxFQUFFO1lBQzdDLE9BQU8sQ0FBQyxJQUFJLENBQUMscUVBQXFFLENBQUMsQ0FBQztTQUNyRjtRQUVELFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7Z0JBQ3pCLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRTtvQkFD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RyxRQUFRLENBQUMsY0FBYyxDQUNyQyxHQUFHLFNBQVMsQ0FBQyxhQUFhLGdCQUFnQixDQUMzQyxDQUFDO1FBRUYsT0FBTyxPQUFPLElBQUksSUFBSSxDQUFDO0lBQ3pCLENBQUM7Q0FDRjtBQUVELGVBQWUsV0FBVyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0eWxlZCBmcm9tICcuL1N0eWxlZCc7XG5pbXBvcnQgeyBDb25zdGFudHMsIEhlbHBlcnMgfSBmcm9tICcuLi91dGlscyc7XG5cbmludGVyZmFjZSBSYW5nZSB7XG4gIGluZGV4OiBudW1iZXI7XG4gIGxlbmd0aDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICBhY2NlcHRzOiBzdHJpbmdbXTtcbiAgdXBsb2FkKGZpbGU6IEZpbGUpOiBQcm9taXNlPHN0cmluZz47XG59XG5cbmNsYXNzIEJhc2VIYW5kbGVyIHtcbiAgcXVpbGw6IGFueTtcbiAgb3B0aW9uczogT3B0aW9ucztcbiAgcmFuZ2U6IFJhbmdlIHwgbnVsbDtcbiAgaGFuZGxlcjogc3RyaW5nO1xuICBsb2FkaW5nOiBIVE1MRWxlbWVudDtcbiAgZmlsZUhvbGRlcjogSFRNTElucHV0RWxlbWVudDtcbiAgaGFuZGxlcklkOiBzdHJpbmc7XG4gIGhlbHBlcnMgPSBuZXcgSGVscGVycygpO1xuICBhbGxvd2VkRm9ybWF0UmVnZXg6IFJlZ0V4cDtcbiAgcG9zc2libGVFeHRlbnNpb246IFNldDxzdHJpbmc+O1xuXG4gIGNvbnN0cnVjdG9yKHF1aWxsLCBvcHRpb25zOiBPcHRpb25zKSB7XG4gICAgdGhpcy5xdWlsbCA9IHF1aWxsO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgdGhpcy5yYW5nZSA9IG51bGw7XG5cbiAgICBuZXcgU3R5bGVkKCkuYXBwbHkoKTtcblxuICAgIGlmICh0aGlzLmlzTm90RXhpc3RMb2FkaW5nKCkpIHtcbiAgICAgIGNvbnN0IG5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgIG5vZGUuaW5uZXJIVE1MID0gdGhpcy5oZWxwZXJzLmxvYWRpbmdIVE1MKCk7XG5cbiAgICAgIHRoaXMucXVpbGwuY29udGFpbmVyLmFwcGVuZENoaWxkKG5vZGUpO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdGhpcy5vcHRpb25zLnVwbG9hZCAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgY29uc29sZS53YXJuKCdbTWlzc2luZyBjb25maWddIHVwbG9hZCBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSBwcm9taXNlIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMub3B0aW9ucy5hY2NlcHRzKSB7XG4gICAgICAgIGlmICh0aGlzLmhhbmRsZXIgPT09IENvbnN0YW50cy5ibG90cy5pbWFnZSkge1xuICAgICAgICAgIHRoaXMub3B0aW9ucy5hY2NlcHRzID0gWydqcGcnLCAnanBlZycsICdwbmcnXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5oYW5kbGVyID09PSBDb25zdGFudHMuYmxvdHMudmlkZW8pIHtcbiAgICAgICAgICB0aGlzLm9wdGlvbnMuYWNjZXB0cyA9IFsnbXA0JywgJ3dlYm0nXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYW5kbGVyID09PSBDb25zdGFudHMuYmxvdHMuaW1hZ2UpIHtcbiAgICAgICAgdGhpcy5wb3NzaWJsZUV4dGVuc2lvbiA9IG5ldyBTZXQoWydhcG5nJywgJ2JtcCcsICdnaWYnLCAnaWNvJywgJ2N1cicsICdqcGcnLCAnanBlZycsICdqZmlmJywgJ3BqcGVnJywgJ3BqcCcsICdwbmcnLCAnc3ZnJywgJ3RpZicsICd0aWZmJywgJ3dlYnAnLCAncGRmJywgJ2RvYycsICdkb2N4JywgJ3BwdCcsICdwcHR4JywgJ3hscycsICd4bHN4J10pO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuaGFuZGxlciA9PT0gQ29uc3RhbnRzLmJsb3RzLnZpZGVvKSB7XG4gICAgICAgIHRoaXMucG9zc2libGVFeHRlbnNpb24gPSBuZXcgU2V0KFsnbXA0JywgJ3dlYm0nLCAnM2dwJywgJ21wNCcsICdtcGVnJywgJ3F1aWNrVGltZScsICdvZ2cnXSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWxsb3dlZEZvcm1hdFJlZ2V4ID0gbmV3IFJlZ0V4cCgnXignICsgdGhpcy5vcHRpb25zLmFjY2VwdHMuZmlsdGVyKChlbCkgPT4gdGhpcy5wb3NzaWJsZUV4dGVuc2lvbi5oYXMoZWwudG9Mb3dlckNhc2UoKSkpXG4gICAgICAucmVkdWNlKChhY2MsIGVsLCBpKSA9PiBhY2MuY29uY2F0KGkgIT09IDAgPyBgfCR7ZWx9YCA6IGAke2VsfWApLCAnJykgKyAnKSQnLCAnaScpO1xuICAgIH0sIDEpO1xuICB9XG5cbiAgYXBwbHlGb3JUb29sYmFyKCkge1xuICAgIGNvbnN0IHRvb2xiYXIgPSB0aGlzLnF1aWxsLmdldE1vZHVsZSgndG9vbGJhcicpO1xuICAgIHRoaXMubG9hZGluZyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFxuICAgICAgYCR7Q29uc3RhbnRzLklEX1NQTElUX0ZMQUd9LlFVSUxMLUxPQURJTkdgXG4gICAgKTtcbiAgICB0b29sYmFyLmFkZEhhbmRsZXIodGhpcy5oYW5kbGVyLCB0aGlzLnNlbGVjdExvY2FsRmlsZS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIHNlbGVjdExvY2FsRmlsZSgpIHtcbiAgICB0aGlzLnJhbmdlID0gdGhpcy5xdWlsbC5nZXRTZWxlY3Rpb24oKTtcbiAgICB0aGlzLmZpbGVIb2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgIHRoaXMuZmlsZUhvbGRlci5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnZmlsZScpO1xuICAgIHRoaXMuZmlsZUhvbGRlci5zZXRBdHRyaWJ1dGUoJ2FjY2VwdCcsIGAke3RoaXMuaGFuZGxlcn0vKmApO1xuICAgIHRoaXMuZmlsZUhvbGRlci5vbmNoYW5nZSA9IHRoaXMuZmlsZUNoYW5nZWQuYmluZCh0aGlzKTtcbiAgICB0aGlzLmZpbGVIb2xkZXIuY2xpY2soKTtcbiAgfVxuXG4gIGxvYWRGaWxlKGNvbnRleHQpIHtcbiAgICB0aGlzLmxvYWRpbmcucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpO1xuICAgIHRoaXMubG9hZGluZy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgQ29uc3RhbnRzLkxPQURJTkdfQ0xBU1NfTkFNRSk7XG5cbiAgICBjb25zdCBmaWxlID0gY29udGV4dC5maWxlSG9sZGVyLmZpbGVzWzBdO1xuICAgIHRoaXMuaGFuZGxlcklkID0gdGhpcy5oZWxwZXJzLmdlbmVyYXRlSUQoKTtcblxuICAgIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgIGZpbGVSZWFkZXIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcbiAgICAgIHRoaXMuaW5zZXJ0QmFzZTY0RGF0YShmaWxlUmVhZGVyLnJlc3VsdCwgdGhpcy5oYW5kbGVySWQpO1xuICAgIH0sIGZhbHNlKTtcblxuICAgIGlmICghZmlsZSkge1xuICAgICAgY29uc29sZS53YXJuKCdbRmlsZSBub3QgZm91bmRdIFNvbWV0aGluZyB3YXMgd3JvbmcsIHBsZWFzZSB0cnkgYWdhaW4hIScpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZmlsZVJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xuXG4gICAgcmV0dXJuIHsgZmlsZSwgaGFuZGxlcklkOiB0aGlzLmhhbmRsZXJJZCB9O1xuICB9XG5cbiAgZmlsZUNoYW5nZWQoKSB7XG4gICAgY29uc3QgeyBmaWxlLCBoYW5kbGVySWQgfSA9IHRoaXMubG9hZEZpbGUodGhpcyk7XG5cbiAgICBpZiAoIWZpbGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBleHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTtcblxuICAgIGlmICghdGhpcy5pc1ZhbGlkRXh0ZW5zaW9uKGV4dGVuc2lvbikpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ1tXcm9uZyBGb3JtYXRdIEZvcm1hdCB3YXMgd3JvbmcsIHBsZWFzZSB0cnkgd2l0aCBjb3JyZWN0IGZvcm1hdCEhJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaGFzVmFsaWRNaW1lVHlwZShmaWxlLnR5cGUpKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBbSW5jb3JyZWN0IE1pbWUgVHlwZV0gVGhlIE1JTUUgVHlwZSBvZiB1cGxvYWRlZCBmaWxlIGlzIG5vdCAke3RoaXMuaGFuZGxlcn0hIWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5lbWJlZEZpbGUoZmlsZSwgaGFuZGxlcklkKTtcbiAgfVxuXG4gIGVtYmVkRmlsZShmaWxlOiBGaWxlLCBoYW5kbGVySWQ6IHN0cmluZykge1xuICAgIHRoaXMub3B0aW9ucy51cGxvYWQoZmlsZSkudGhlbihcbiAgICAgICh1cmwpID0+IHtcbiAgICAgICAgdGhpcy5pbnNlcnRGaWxlVG9FZGl0b3IodXJsLCBoYW5kbGVySWQpO1xuICAgICAgICB0aGlzLmxvYWRpbmcucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpO1xuICAgICAgICB0aGlzLmxvYWRpbmcuc2V0QXR0cmlidXRlKCdjbGFzcycsIENvbnN0YW50cy5OT05FX0RJU1BMQVlfQ0xBU1NfTkFNRSk7XG4gICAgICB9LFxuICAgICAgKGVycm9yKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZy5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7XG4gICAgICAgIHRoaXMubG9hZGluZy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgQ29uc3RhbnRzLk5PTkVfRElTUExBWV9DTEFTU19OQU1FKTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChoYW5kbGVySWQpO1xuICAgICAgICAgIGVsLnJlbW92ZSgpO1xuICAgICAgICB9LCAxMDAwKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgaW5zZXJ0QmFzZTY0RGF0YSh1cmw6IHN0cmluZyB8IEFycmF5QnVmZmVyLCBoYW5kbGVySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJhbmdlID0gdGhpcy5yYW5nZTtcbiAgICB0aGlzLnF1aWxsLmluc2VydEVtYmVkKFxuICAgICAgcmFuZ2UuaW5kZXgsXG4gICAgICB0aGlzLmhhbmRsZXIsXG4gICAgICBgJHtoYW5kbGVySWR9JHtDb25zdGFudHMuSURfU1BMSVRfRkxBR30ke3VybH1gXG4gICAgKTtcblxuICAgIGNvbnN0IGVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaGFuZGxlcklkKTtcblxuICAgIGlmIChlbCkge1xuICAgICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIENvbnN0YW50cy5RVUlMTF9VUExPQURfSE9MREVSX0NMQVNTX05BTUUpO1xuICAgIH1cbiAgfVxuXG4gIGluc2VydEZpbGVUb0VkaXRvcih1cmw6IHN0cmluZywgaGFuZGxlcklkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGhhbmRsZXJJZCk7XG4gICAgaWYgKGVsKSB7XG4gICAgICBlbC5zZXRBdHRyaWJ1dGUoJ3NyYycsIHVybCk7XG4gICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7XG4gICAgICBlbC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7XG4gICAgfVxuICB9XG5cbiAgaXNWYWxpZEV4dGVuc2lvbihleHRlbnNpb246IHN0cmluZykge1xuICAgIHJldHVybiBleHRlbnNpb24gJiYgdGhpcy5hbGxvd2VkRm9ybWF0UmVnZXgudGVzdChleHRlbnNpb24pO1xuICB9XG5cbiAgaGFzVmFsaWRNaW1lVHlwZSh0eXBlOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdHlwZSAmJiB0eXBlLnN0YXJ0c1dpdGgodGhpcy5oYW5kbGVyKTtcbiAgfVxuXG4gIGlzTm90RXhpc3RMb2FkaW5nKCkge1xuICAgIGNvbnN0IGxvYWRpbmcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcbiAgICAgIGAke0NvbnN0YW50cy5JRF9TUExJVF9GTEFHfS5RVUlMTC1MT0FESU5HYFxuICAgICk7XG5cbiAgICByZXR1cm4gbG9hZGluZyA9PSBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEJhc2VIYW5kbGVyO1xuIl19